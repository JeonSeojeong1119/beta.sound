<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beta Sound</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column}
    .drop-area {
      flex: 1;
      background-image: url("background.png");
      background-repeat: no-repeat;
      background-position: center center;
      background-size: cover;
      position: relative;
      overflow: hidden;
    }

    .hover-bar {
      position: fixed;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(255,255,255,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      padding: 10px 20px;
      z-index: 1000;
      border-radius: 10px;
      transition: width 0.3s;
    }

    .hover-bar i {
      color: #353636;
      font-size: 50px;
      cursor: pointer;
      transition: transform 0.2s, opacity 0.3s;
    }
    .hover-bar i:hover {
      transform: scale(1.2);
    }
    .hover-bar i.hidden {
      display: none;
    }

    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border: 1px solid #353636;
      border-radius: 10px;
      display: none;
      z-index: 2000;
    }

    .popup button {
      margin-top: 10px;
      padding: 5px 10px;
    }

    img.draggable {
      width: 300px;
      position: absolute;
      cursor: grab;
      user-select: none;
    }
  </style>
</head>
<body>

  <div class="drop-area" id="dropArea"></div>

  <div class="popup" id="popup">
    <h2>Beta Sound</h2>
    <img src="image-blueprint.jpg" height="300px">
    <p>무언가를 만드는 사람의 손끝에서는 다양한 소리들이 끊임없이 탄생합니다. 이 소리들은 아직 완성되지 않았기에 더 생생하고, 무한한 가능성을 들려줍니다.
각각은 단편적이고 불완전한 소리들일지 몰라도, 이들은 관람객의 손을 거쳐 겹쳐지고, 배열되며 즉흥적인 하나의 사운드 풍경(soundscape)으로 만들어집니다.

이러한 방식은 우리들의 창의적인 실험과 새로운 도전을 허용하는 ‘베타 스페이스’의 모습과도 닮아 있으며, 완성된 하나의 결과물이 아닌 계속해서 변화할 수 있는 조합을 관람객이 직접 체험해보게 됩니다.</p>
    <button onclick="closePopup()">시작하기</button>
  </div>

  <div class="hover-bar" id="hoverBar">
    <i class="fa-solid fa-house" onclick="openPopup()"></i>
    <i class="fa-solid fa-user" draggable="true" ondragstart="drag(event)"></i>
    <i class="fa-solid fa-envelope" draggable="true" ondragstart="drag(event)"></i>
    <i class="fa-solid fa-bell" draggable="true" ondragstart="drag(event)"></i>
    <i class="fa-solid fa-heart" draggable="true" ondragstart="drag(event)"></i>
    <i class="fa-solid fa-gear" draggable="true" ondragstart="drag(event)"></i>
    <i class="fa-solid fa-camera" draggable="true" ondragstart="drag(event)"></i>
    <i id="trash" class="fa-solid fa-trash" ondragover="allowDrop(event)" ondrop="deleteIcon(event)"></i>
  </div>

  <script>
  const iconAssets = {
    "fa-user":    { img: "img-barrow.PNG", sound: "sound-click.mp3", size: 300, volume: 0.2 },
    "fa-envelope":{ img: "img-cone.PNG", sound: "sound-drawing.mp3", size: 150, volume: 7.0},
    "fa-bell":    { img: "img-helmet.PNG", sound: "sound-printer.mp3", size: 180, volume: 0.3 },
    "fa-heart":   { img: "img-machine.PNG", sound: "sound-tape.mp3", size: 400, volume: 15.0 },
    "fa-gear":    { img: "img-roller.PNG", sound: "sound-tear.mp3", size: 150, volume: 0.1 },
    "fa-camera":  { img: "img-shovel.PNG", sound: "sound-typing.mp3", size: 180, volume: 15.0 }
  };

  const dropArea = document.getElementById('dropArea');
  const hoverBar = document.getElementById('hoverBar');
  const audioMap = new Map();
  const activeIcons = new Set();

  function openPopup() {
    document.getElementById("popup").style.display = "block";
  }
  function closePopup() {
    document.getElementById("popup").style.display = "none";
  }

  function allowDrop(event) {
    event.preventDefault();
  }

  function drag(event) {
    if (!event.target.id) {
      event.target.id = "icon-" + Date.now();
    }
    event.dataTransfer.setData("iconId", event.target.id);
    event.dataTransfer.setData("iconClass", event.target.className);
  }

  dropArea.addEventListener("dragover", allowDrop);

  dropArea.addEventListener("drop", function(event) {
    event.preventDefault();
    const iconClass = event.dataTransfer.getData("iconClass");
    if (iconClass) {
      const faClass = iconClass.split(" ").find(cls => cls.startsWith("fa-") && cls !== "fa-solid");
      if (faClass && iconAssets[faClass]) {
        if (activeIcons.has(faClass)) return; // 중복 방지
        activeIcons.add(faClass);

        const asset = iconAssets[faClass];
        const newImg = document.createElement("img");
        newImg.src = asset.img;
        newImg.className = "draggable";
        newImg.id = "icon-" + Date.now();
        newImg.style.width = asset.size + "px";
        newImg.style.height = "auto";

        const rect = dropArea.getBoundingClientRect();
        newImg.style.left = (event.clientX - rect.left - 50) + "px";
        newImg.style.top = (event.clientY - rect.top - 50) + "px";

        dropArea.appendChild(newImg);

        // 마우스 이동 가능
        makeMovable(newImg);

        // 삭제 가능하도록 dragstart 이벤트 등록
        newImg.addEventListener("dragstart", e => {
          e.dataTransfer.setData("iconId", newImg.id);
        });
        newImg.draggable = true; // trash로 드래그 가능

        // 오디오 실행
        const audio = new Audio(asset.sound);
        audio.loop = true;
        audio.play();
        audioMap.set(newImg.id, { audio, faClass });

        // hover-bar 아이콘 숨김
        document.querySelector(`.hover-bar .${faClass}`).classList.add("hidden");
      }
    }
  });

  function makeMovable(el) {
    let offsetX, offsetY, isDragging = false;
    el.addEventListener("mousedown", e => {
      isDragging = true;
      offsetX = e.offsetX;
      offsetY = e.offsetY;
      el.style.cursor = "grabbing";
    });
    document.addEventListener("mousemove", e => {
      if (isDragging) {
        const rect = dropArea.getBoundingClientRect();
        el.style.left = (e.clientX - rect.left - offsetX) + "px";
        el.style.top = (e.clientY - rect.top - offsetY) + "px";
      }
    });
    document.addEventListener("mouseup", () => {
      isDragging = false;
      el.style.cursor = "grab";
    });
  }

  function deleteIcon(event) {
    event.preventDefault();
    const iconId = event.dataTransfer.getData("iconId");
    if (iconId) {
      const dragged = document.getElementById(iconId);
      if (dragged) {
        const entry = audioMap.get(iconId);
        if (entry) {
          entry.audio.pause();
          audioMap.delete(iconId);
          activeIcons.delete(entry.faClass);
          // hover-bar 아이콘 다시 보이기
          document.querySelector(`.hover-bar .${entry.faClass}`).classList.remove("hidden");
        }
        dragged.remove();
      }
    }
  }
  </script>
</body>
</html>